<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, width=device-width">
  <link rel="stylesheet" href="../../assets/css/style.css">
  <!-- packery.js -->
  <script src="https://unpkg.com/packery@2/dist/packery.pkgd.js"></script>
  <!-- draggie.js -->
  <script src="https://unpkg.com/draggabilly@3/dist/draggabilly.pkgd.min.js"></script>

  <script src="../../assets/js/script.js"></script>

  <title>GETIS</title>
</head>

<body>
  <div class="gts-gnb flex-group">
    <div class="prefix">
      <div class="home">
        <a href="" class="toggle-lnb">
          <i class="icon-lnb-toggle"></i>
        </a>
        <h1>
          <a href="">
            <i class="logo">GETIS</i>
          </a>
        </h1>
      </div>
      <div class="menu-list">
        <ul>
          <li class="on">
            <a href="">툴링 생산관리</a>
            <ul class="sub-menu">
              <li><a href="">G-PAMS</a></li>
              <li><a href="">프레스금현생산 관리</a></li>
              <li><a href="">신소재금형생산관리</a></li>
              <li><a href="" class="on">플라스틱금형생산관리</a></li>
              <li><a href="" class="disabled">disabled</a></li>
            </ul>
          </li>
          <li><a href="">일반 관리</a></li>
          <li><a href="">전동화 생산관리</a></li>
          <li><a href="">협력사</a></li>
          <li><a href="">공통</a></li>
        </ul>
      </div>
    </div>
    <div class="suffix">
      <div class="gnb-menu">
        <ul>
          <li><a href=""><i class="icon-istm" title="ISTM"></i></a></li>
          <li><a href=""><i class="icon-app" title="app"></i></a></li>
          <li><a href=""><i class="icon-memo" title="memo"></i></a></li>
          <li><a href=""><i class="icon-help" title="help"></i></a></li>
          <li><a href=""><i class="icon-language" title="language"></i></a></li>
          <li><a href=""><i class="icon-mypage" title="mypage"></i></a></li>
        </ul>
      </div>
      <div class="mypage">
        <a href=""><span class="name">홍길동</span>&nbsp;님<span class="department">(기준정보시스템팀)</span></a>
      </div>
    </div>
  </div>
  <div class="content-wrap">
    <div class="gts-lnb">
      <div class="tab-container">
        <div class="header">
          <a href="" class="tab on" data-tab="tab-1"><i class="icon-star"></i>즐겨찾기</a>
          <a href="" class="tab" data-tab="tab-2"><i class="icon-time"></i>최근메뉴</a>
          <a href="" class="tab" data-tab="tab-3"><i class="icon-allmenu"></i>전체메뉴</a>
        </div>
        <div class="body">
          <div class="tab-content-wrap">
            <div class="tab-content tab-1 favorite-menu menu-tree edit on">
              <div class="add">
                <input type="text" class="gts-input w-180" placeholder="폴더명/메뉴명 입력">
                <span class="add-btn"><i class="icon-add-menu"></i></span>
              </div>

              <div id="menu" class="menu">
                <div class="menu-content">
                  <ul id="menu-list">
                    <li class="draggable" draggable="true" data-hasChild="true">
                      사용자 직접생성 폴더1 

                      <span class="delete-btn" onclick="removeMenu(this)"><i class="icon-delete-folder"></i></span>
                      <span class="toggle-btn"><i class="icon-toggle-arrow-down"></i></span>
                      <ul class="sub-menu">
                        <li class="draggable" draggable="true">
                          메뉴 1.1
                          <span class="delete-btn" onclick="removeMenu(this)"><i class="icon-delete-menu"></i></span>
                        </li>
                        <li class="draggable" draggable="true">
                          메뉴 1.2
                          <span class="delete-btn" onclick="removeMenu(this)"><i class="icon-delete-menu"></i></span>
                        </li>
                      </ul>
                    </li>
                    <li class="draggable" draggable="true" data-hasChild="true">
                      사용자 직접생성 폴더2 
                      <span class="delete-btn" onclick="removeMenu(this)"><i class="icon-delete-folder"></i></span>
                      <span class="toggle-btn"><i class="icon-toggle-arrow-down"></i></span>
                      <ul class="sub-menu">
                        <li class="draggable" draggable="true">
                          메뉴 2.1
                          <span class="delete-btn" onclick="removeMenu(this)"><i class="icon-delete-menu"></i></span>
                        </li>
                        <li class="draggable" draggable="true">
                          메뉴 2.2
                          <span class="delete-btn" onclick="removeMenu(this)"><i class="icon-delete-menu"></i></span>
                        </li>
                      </ul>
                    </li>
                    <li class="draggable" draggable="true" data-hasChild="false">
                      사용자 직접생성 메뉴3
                      <span class="delete-btn" onclick="removeMenu(this)"><i class="icon-delete-folder"></i></span>
                    </li>
                  </ul>
                </div>
              </div>

              <div class="footer">
                <div class="btn-group">
                  <a href="javascript:void(0)" class="btn" onclick="editFavorite(this)">즐겨찾기관리</a>
                  <a href="" class="btn">Sitemap</a>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</body>
<script>
  // LNB draggable
  let lnbFavEdit;
  let lnbGridElement;
  let lnbGridItems;
  let lnbDragged;
  let lnbDropTargetWidth;


  let favItem = document.querySelectorAll('.favorite-menu.edit .depth--1 > li');
  lnbGridElement = document.querySelector('.favorite-menu .grid');
  lnbGridItems = document.querySelectorAll('.favorite-menu .grid.depth--1 > li');

  lnbFavEdit = new Packery(lnbGridElement, {
    itemSelector: '.favorite-menu .grid > li'
  })

  console.log('lnbFavEdit', lnbFavEdit);

  // Menu Dragging

  const menu = document.getElementById('menu');
  let draggedItem = null;

  // Draggable functionality
  document.querySelectorAll('.draggable').forEach(item => {
    item.addEventListener('dragstart', (e) => {
      draggedItem = e.target;
      e.target.classList.add('dragging');
    });

    item.addEventListener('dragend', (e) => {
      e.target.classList.remove('dragging');
      draggedItem = null;
    });

    item.addEventListener('dragover', (e) => {
      e.preventDefault();
      // console.log('dragover', e.target.classList);
      if (e.target.tagName === 'LI' && e.target !== draggedItem) {
        e.target.classList.add('drag-over');
        const rect = e.target.getBoundingClientRect();
        const offsetY = e.clientY - rect.top;
        // console.log('drag', offsetY - rect.height / 2);
        if(offsetY - rect.height / 2 < -5){
          // 윗쪽
          e.target.classList.add('topper');
          e.target.classList.remove('bottom');
        } else if(offsetY - rect.height / 2 > 5){
          // 아랫쪽
          e.target.classList.add('bottom');
          e.target.classList.remove('topper');
        } else {
          // 가운데
          e.target.classList.remove('bottom');
          e.target.classList.remove('topper');
        }
      }
    });

    item.addEventListener('dragleave', (e) => {
      e.target.classList.remove('drag-over', 'topper');
    });
    item.addEventListener('drag', (e) => {
      // console.log('drag', e.target);
    })

    item.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      e.target.classList.remove('drag-over', 'topper');
      e.target.style.backgroundColor = ''; // Reset background color

      if (e.target.tagName === 'LI' && e.target !== draggedItem) {
        const parent = e.target.parentNode;
        const allItems = Array.from(parent.children);
        const draggedIndex = allItems.indexOf(draggedItem);
        const targetIndex = allItems.indexOf(e.target);

        const rect = e.target.getBoundingClientRect();
        const offsetY = e.clientY - rect.top;
        if ( offsetY - rect.height / 2 > 5) {
          // 타겟의 아래쪽에 추가
          parent.insertBefore(draggedItem, e.target.nextSibling);
        } else if ( offsetY - rect.height / 2 < -5){
          // 윗쪽에 추가
          parent.insertBefore(draggedItem, e.target);
        } else {
          // 하위에 추가
          let haschild = e.target.dataset.haschild;
          let submenu = document.createElement('ul');
          submenu.classList.add('sub-menu');
          console.log(haschild);
          if(haschild == 'false'){
            // 하위메뉴가 없다면
            let toggle = document.createElement('span');
            toggle.classList.add('toggle-btn');
            toggle.innerHTML = '<i class="icon-toggle-arrow-down"></i>';
            submenu.appendChild(draggedItem);
            e.target.appendChild(toggle);
            e.target.appendChild(submenu);
            let newBtn = e.target.querySelector('.toggle-btn');
            handlerToggleBtn(newBtn);
            e.target.dataset.haschild = 'true';
          } else if(haschild == 'true'){
            
            e.target.querySelector('.sub-menu').appendChild(draggedItem);
          }
        }
      } else if (e.target.tagName === 'UL') {
        const ul = e.target;
        ul.appendChild(draggedItem);
      }
    });
  });

  // Menu Dragging
  let isDragging = false;
  let offsetX, offsetY;


  function onMouseMove(e) {
    if (isDragging) {
      menu.style.left = `${e.clientX - offsetX}px`;
      menu.style.top = `${e.clientY - offsetY}px`;
    }
  }

  function onMouseUp() {
    isDragging = false;
    document.removeEventListener('mousemove', onMouseMove);
    document.removeEventListener('mouseup', onMouseUp);
  }

  // Toggle Sub-menu
  document.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const subMenu = btn.nextElementSibling;
      if (subMenu.style.display === 'none' || subMenu.style.display === '') {
        subMenu.style.display = 'block';
        btn.classList.add('open');
      } else {
        subMenu.style.display = 'none';
        btn.classList.remove('open');
      }
    });
  });
  function handlerToggleBtn(btn){
    btn.addEventListener('click', () => {
      const subMenu = btn.nextElementSibling;
      if (subMenu.style.display === 'none' || subMenu.style.display === '') {
        subMenu.style.display = 'block';
        btn.classList.add('open');
      } else {
        subMenu.style.display = 'none';
        btn.classList.remove('open');
      }
    });
  }
  function removeMenu(e){
    if(confirm('삭제하시겠습니까?')){
      e.parentNode.remove();
    }
    
  }

</script>

</html>